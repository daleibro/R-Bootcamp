---
title: "R-Bootcamp - Analysis of Building Projects in Zurich"
author: "Keith Lawless, Daniel Leibrock"
date: "2022-08-29"
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
  pdf_document:
    toc: yes
    toc_depth: 3
subtitle: "MSC.IDS - HSLU Lucerne"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
data <- read.csv("Data/BAU502OD5023.csv", encoding = "UTF-8")
prices <- read.csv("Data/BAU514OD5142.csv")
location <- read.csv("Data/stzh.adm_statzonen_beschr_p.csv")
```

```{r packages, include=FALSE}
library(dplyr)
library(shiny)
library(knitr)
library(ggplot2)
library(forecast)
library(kableExtra)
library(gridExtra)
library(formattable)
library(reshape2)
```

## Introduction to the Analysis

### Selection of the dataset

The dataset we want to analyze in the cause of this project, is the "**Neubauwohnungen nach Bauprojektstatus, Eigentumsart und statistischer Zone seit 2009**" dataset from the opendata.swiss website. The dataset contains information about housing projects in the city of Zurich since 2009 and holds information such as project status, ownership and location of the project. Furthermore, we add enriching data regarding real estate prices as well as adress data from the City of Zurich Open Data Portal to enrich our main dataset. 

......

### Goals of the Analysis

The goal of the Analysis is to get an insight into the development of the real estate market in Zurich throughout the past decade. We want to offer a diverse view on several aspects of the market, including the development of different types of projects, prices, owners and locations. Through this, we want to identify trends and offer an overview of the market structure.

### Research questions

Following the previous introduction and the goals of our analysis, we aim to answer the following research questions:

1) How did the number of overall building projects develop over time in different statistical zones / quartiers?
2) Who are the main owners / drivers of building projects?
3) Does the share of different building size groups change over time?
4) How did prices in the different parts of the city (quartiers) change over time?
5) Is there a relation between price development and building project development?

......


## Data Preparation

Data preparation consists of several steps. These include:

  - Deletion of obsolete columns from the different data sets
  - Renaming of several columns
  - Grouping and summarising of several columns 
  - Merging of the different datasets
  


```{r Prep_Main, echo = FALSE, include = FALSE}
drop_cols_data <- c("StatZoneSort", "QuarSort", "QuarCd", "KreisSort", "KreisCd", "ProjStatusSort", "EigentumsartSort")

datareduced <- data %>%
  select(- all_of(drop_cols_data)) %>%
  group_by(Jahr, KreisLang, QuarLang, StatZoneCd,ProjStatus, Eigentumsart, AnzWhg) %>%
  summarise(WhgSum = sum(AnzWhg))

#head(datareduced, n = 10)

datareduced_2 <- data %>%
  select(- all_of(drop_cols_data)) %>%
  group_by(Jahr, KreisLang) %>%
  summarise(WhgSum = sum(AnzWhg))

#head(datareduced_2, n = 40)

#write.csv(datareduced, "main.csv", fileEncoding = "UTF-8")
```

```{r Prep_Prices, echo = FALSE, include = FALSE}
drop_cols_prices <- c("QuarCd", "ZoneSort", "FrQmBodenNettoGanzeLieg", "FrQmBodenNettoStwE", "FrQmBodenNettoAlleHA")
price_cols <- c("FrQmBodenGanzeLieg", "FrQmBodenStwE", "FrQmBodenAlleHA", "FrQmWohnflStwE")
price_cols_renamed <- c("CHF / $m^{2}$ Boden (Ganze Liegensch.)", "CHF / $m^{2}$ Boden (Stockwerkb.)", "CHF / $m^{2}$ Boden (Kombiniert)", "CHF / $m^{2}$ Wohnfläche (Stockwerkb.)")

pricesreduced <- prices %>%
  select(- all_of(drop_cols_prices)) %>%
  filter(Typ != "Zahl") %>%
  mutate(FrQmBodenGanzeLieg = replace(FrQmBodenGanzeLieg, FrQmBodenGanzeLieg == ".", "")) %>%
  mutate(FrQmBodenStwE = replace(FrQmBodenStwE, FrQmBodenStwE == ".", "")) %>%
  mutate(FrQmBodenAlleHA = replace(FrQmBodenAlleHA, FrQmBodenAlleHA == ".", "")) %>%
  mutate(FrQmWohnflStwE = replace(FrQmWohnflStwE, FrQmWohnflStwE == ".", "")) %>%
  mutate_at(price_cols, as.integer) %>%
  group_by(QuarLang, Jahr) %>%
  summarise_at(price_cols, mean, na.rm = TRUE)
  
#head(pricesreduced, n = 50)

#write.csv(pricesreduced, "pricesreduced.csv", fileEncoding = "UTF-8")
#typeof(prices$FrQmBodenGanzeLieg)
#str(pricesreduced)
```



```{r Prep_Locations, echo = FALSE, include = FALSE}
#head(location, n = 10)
#summary(location)

drop_cols_location <- c("objid", "name", "ori", "hali", "vali")

location <- location %>%
  select(- all_of(drop_cols_location))
```


```{r Merge, echo = FALSE, include = FALSE}
datacomb <- left_join(datareduced, pricesreduced, by = c("QuarLang" = "QuarLang", "Jahr" = "Jahr"))
#head(datacomb, n = 10)

datafinal <- left_join(datacomb, location, by = c("StatZoneCd" = "kuerzel"))
head(datafinal, n = 100)

#write.csv(datafinal, "datafinal.csv", encoding = "UTF-8")
#readr::write_excel_csv(datafinal, "datafinal.csv")
```

## Exploratory Data Analysis

```{r EDA, echo = FALSE, include = FALSE}
summary(datafinal)
ImBau <- datafinal %>% 
  filter(ProjStatus == "Im Bau")
Bewilligt <- datafinal %>% 
  filter(ProjStatus == "Bewilligt")

sum(ImBau$AnzWhg) 
sum(Bewilligt$AnzWhg)
sapply(datafinal, function(x) n_distinct(x))
str(datafinal)
summary(datafinal)
```

The summary of the final dataframe reveals several insights about the general structure of the data as well as the real estate market itself. 

Regarding the general structure of the data, we can see that in total **27950 different datapoints** spread over a period of 13 years from **2009 until 2021**. In total, projects with a volume of **51016 apartments received approval** while **69194 appartments started construction** in Zurich during this period.  
*It is not clear, if individual apartments can appear in both categories at different points of time.*
 
The projects are located within **12 "Kreise" / regions**,  split into **34 "Quartiere" / districts** which are then again differentiated into **215 statistical zones**, the most granular geo-statistical level for the city of Zurich. While data about the number of apartments and geographic coordinates is available on this level, price data is only available on Quartier-level. Furthermore, the projects are assigned to **5 different types of ownership**.  


<br/>

## Visual Data Analysis  

In this chapter, we want to visually analyze the structure of the real estate market. Lorem ipsum...

```{r Test, echo = FALSE, eval = FALSE}
testplot <-
  ggplot(data = datareduced_2,
         mapping = aes(y = WhgSum, x = Jahr, colour = KreisLang)) + geom_line()

testplot
```

```{r Price_table, echo = FALSE}
cols <- c("Jahr", "QuarLang", "FrQmBodenGanzeLieg", "FrQmBodenStwE", "FrQmBodenAlleHA", "FrQmWohnflStwE")
price_cols_renamed <- c("CHF / $m^{2}$ Boden (Ganze Liegensch.)", "CHF / $m^{2}$ Boden (Stockwerkb.)", "CHF / $m^{2}$ Boden (Kombiniert)", "CHF / $m^{2}$ Wohnfläche (Stockwerkb.)")
kreis_renamed <- c(1:12)

pricetable <- datafinal %>% 
  rename_at(all_of(price_cols), function(x) price_cols_renamed) %>% 
  rename(Quartier = QuarLang) %>% 
  rename(Kreis = KreisLang) %>%  
  group_by(Jahr, Kreis, Quartier) %>% 
  summarise_at(price_cols_renamed, mean, na.rm = TRUE)

yearprices <- pricetable %>% 
  group_by(Jahr) %>% 
  summarise_at(price_cols_renamed, mean, na.rm = TRUE)

kreisprices <- pricetable %>% 
  group_by(Kreis) %>%
  summarise_at(price_cols_renamed, mean, na.rm = TRUE)

quartierprices <- pricetable %>% 
  group_by(Quartier) %>% 
  summarise_at(price_cols_renamed, mean, na.rm = TRUE)
```

### Price developments and differences

#### Average price development per sq.m. of condominium ownership and ground (CHF)
<br/>

As a first visual analysis of the data we will look at price developments on different levels. We want to get an overview of the development of yearly-averaged prices over time, split in the different categories available. These are CHF / $m^{2}$ Boden (Ganze Liegenschaft), CHF / $m^{2}$ Boden (Stockwerkbesitz), CHF / $m^{2}$ Boden (Kombiniert) as well as CHF / $m^{2}$ Wohnfläche (Stockwerkbesitz). 

**The following table and plot show information about real estate prices averaged over the whole city of Zurich for each year in CHF:**  
<br/><br/>

```{r yearprices, echo = FALSE}
formattable(yearprices,
            "Jahr" = list(color = "grey", font.weight = "bold"))
```

<br/><br/>

```{r yearprices_plot, echo = FALSE, warning = FALSE, message = FALSE}
ggplot(yearprices, aes(x = Jahr)) +
  geom_smooth(span = .2, aes(y = `CHF / $m^{2}$ Wohnfläche (Stockwerkb.)`), size = 1, color = "brown2") +
  geom_smooth(span = .2, aes(y = `CHF / $m^{2}$ Boden (Stockwerkb.)`), size = 0.5, linetype = "dashed") +
  geom_smooth(span = .2, aes(y = `CHF / $m^{2}$ Boden (Ganze Liegensch.)`), size = 0.5, linetype = "dashed") +
  geom_smooth(span = .2, aes(y = `CHF / $m^{2}$ Boden (Kombiniert)`), size = 1) + 
  geom_smooth(aes(y = `CHF / $m^{2}$ Wohnfläche (Stockwerkb.)`), method = "lm", size = 1, color = "brown2", se = FALSE, linetype = "dashed") +
  geom_smooth(aes(y = `CHF / $m^{2}$ Boden (Kombiniert)`), method = "lm", size = 1, se = FALSE, linetype = "dashed") +
  theme(
    panel.grid.major = element_line(colour = "gray80"),
    panel.grid.minor = element_line(colour = NA),
    axis.text = element_text(family = "sans",
                             face = "bold"),
    panel.background = element_rect(fill = "white")
  ) +
  ylab("") +
  xlab("")

```

As we can see, the overall price trend is clearly upwards. The red curve, which represents the price for living space / Wohnfläche in condominium ownership / Stockwerkbesitz, is showing a continuous and constant **growth of about 575 CHF per year** over the observed timeline. The thick blue curve, which represents the price for ground / Boden, combined for both Stockwerkbesitz (upper dashed, blue line) and whole buildings / ganze Liegenschaft (lower dashed, blue line), reveals a yearly average **price increase of about 1000 CHF**.  
<br/><br/>

#### Average price per sq.m. of condominium ownership and ground (CHF) per Kreis  
<br/><br/>

```{r kreisprices, echo = FALSE}
formattable(kreisprices,
            "Kreis" = list(color = "grey", font.weight = "bold"))
```

<br/><br/>

```{r kreisprices_plot, echo = FALSE}
dfm <- melt(kreisprices[,c('Kreis','CHF / $m^{2}$ Wohnfläche (Stockwerkb.)','CHF / $m^{2}$ Boden (Kombiniert)')],id.vars = 1)
dfm <- dfm %>% 
    mutate(across(where(is.factor), as.character)) %>%
    mutate(variable = replace(variable, variable == "CHF / $m^{2}$ Wohnfläche (Stockwerkb.)", "Preis / qm. Wohnfläche")) %>% 
    mutate(variable = replace(variable, variable == "CHF / $m^{2}$ Boden (Kombiniert)", "Preis / qm. Boden"))

ggplot(dfm, aes(x = reorder(Kreis, -value), y = value)) + 
    geom_bar(aes(fill = variable), stat = "identity", position = "dodge") + 
    scale_y_continuous() +
    ylab("") +
    xlab("") + 
    theme(panel.grid.major = element_line(colour = "gray80"), legend.title = element_text(colour = NA), 
      panel.background = element_rect(fill = "white")) +labs(x = NULL, y = NULL) + theme(legend.position = "top")

plot_1 <- 
  ggplot(kreisprices) +
    aes(x = Kreis, fill = Kreis) +
    geom_col(aes(y = `CHF / $m^{2}$ Wohnfläche (Stockwerkb.)`), show.legend = FALSE) +
    scale_fill_hue(direction = 1) +
    xlab("") +
    ylab("")

plot_2 <-
  ggplot(kreisprices) +
    aes(x = Kreis, fill = Kreis) +
    geom_col(aes(y = `CHF / $m^{2}$ Boden (Kombiniert)`), show.legend = FALSE) +
    scale_fill_hue(direction = 1) +
    xlab("") +
    ylab("")

#grid.arrange(plot_1, plot_2, nrow = 1)
```


### Special Topic: Leaflet with R/Shiny

For our chapter of choice, we chose leaflet and integrate it with a simple Shiny App. A preview of the app is shown below. 
[Alternatively, the app is available online by clicking here.](https://vordaten.shinyapps.io/StadtZurich/ "Click to open the app in a new tab")

```{r VDA_2, fig.width=13}
knitr::include_app("https://vordaten.shinyapps.io/StadtZurich/", height = "600px")
```


#### Experience with Leaflet and Shiny Integration

Our main goal with leaflet was to provide a rich interactive experience for users of our app, such that they could intuitively explore the cleaned dataset. Initially, there were some challenges to overcome and ultimately, we were not entirely satisfied with the final outcome. However, in development of the app, some of the challenges we encountered forced us to change our design thinking on the overall role that maps can play as part of a rich, interactive visual that can tell a useful story which is in itself a great thing.

#### Leaflet Pros

Firstly, the range of base map options that are available with leaflet are stunning. In the opinion of the authors, this option alone makes leaflet the only option when it comes to implementing maps ahead of Commerical tools such as Tableau and PowerBI (PowerBI in particular is limited here).

Secondly, the code to quickly develop a map is straightforward. Add your data, chose a basemap, select the marker types you would like and customise. 

Next - the options to fix the boundaries, zoom level and focus point are a big advantage. Again, options like these are absent from tools like PowerBI. In these tools, it is entirely possible to mistakenly zoom out of the map or move it to another area with no way to reset them. With leaflet, you can help the user by ensuring they do not stray from the area of the map containing the interesting data points.

#### Leaflet Cons

As mentioned, we experienced a couple of challenges. Firstly performance.
We would have liked to pass the entire dataset to Leaflet and for it to summarise as needed in the background. However, when we did this, R-Studio frequently crashed. As a result, we condensed the dataset down into an aggregated format, such that the map would display quickly and comfortably.

Secondly, and somewhat related, it was frustrating not to be able to use the map as a filter by clicking on one of the polygons.
The package does indeed contain functionality for generating map click events, however, to pass these events to other elements in our app would have meant that we also pre-aggregated the data inputs supporting this element which was not possible for all elements.

#### Leaflet Conclusions

Overall we would recommend leaflet as a map visualization. As mentioned, due to some of the challenges we would recommend to our users that they think of how we use maps somewhat differently. A personal frustration of the author is when searching an address on Google maps, it zooms right into the lowest level of the map. Therefore, a wider context is missing. Extra steps are required in order for me to zoom out and get a general idea of where the location is (in relation to the city center, nearest train station, motorway, etc.).

I would like to make decisions based on that context (is it better to drive or get the train) and I can worry about the exact location later when I am approaching.

Similarly with leaflet, I think it is more interesting for users to click on a datapoint and then see that update in the context of the fixed map. 

Additionally, performance remains a concern. I would recommend to our client the use of SQL inside the app could be used to take click events and perform the map filtering in the data set in the database, before returning the results of that aggregated query to the map or other element for the visualization. 


## Modelling and Prediction

### Model XYZ

```{r Model}

```

### Prediction XYZ

```{r Prediction}

```

## Summary and Conclusion

